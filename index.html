<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Dashboard Avicoli — Blocchi Integrati</title>

<!-- ====== STILI GLOBALI MINIMI (non interferenti) ====== -->
<style>
  :root{ --container-w: min(96vw, 1200px); }
  html, body { height:100%; }
  body{
    margin:0; background:#0a0a0b; color:#f5f5f7;
    font-family:-apple-system,system-ui,Segoe UI,Roboto,sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .block { padding:16px; display:flex; flex-direction:column; align-items:center; gap:12px; }
  .block + .block { border-top:1px solid #232429; margin-top:8px; padding-top:24px; }
  /* NASCONDI titoli Blocco 1/2/3, mantenendo markup per accessibilità */
  .block h1.block-title{ position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden; }
</style>

<!-- Uniform wrap per tutti i blocchi (stessa gabbia del Blocco 3) -->
<style>
  .wrap{width:100%;max-width:var(--container-w);margin:0 auto;display:grid;gap:14px}
</style>

<!-- ====== BLOCCO 1: Agenda Macellazione — Navigazione Settimane ====== -->
<style>
  #agenda { --bg:#0b0b0c; --panel:#16181c; --border:#2b2d31; --text:#f5f5f7; --accent:#ffd60a; --muted:#9ea1a5; --radius:10px; --shadow:0 6px 18px rgba(0,0,0,.35); }
  #agenda .a-root{background:var(--bg); color:var(--text); display:flex; flex-direction:column; align-items:center; gap:12px; width:100%;}
  #agenda .a-root h1{font-size:18px;font-weight:800;color:var(--accent);text-transform:uppercase;letter-spacing:.4px;margin:0}

  #agenda .week-nav{display:flex;align-items:center;gap:10px;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:6px 10px;box-shadow:var(--shadow)}
  #agenda .btn{appearance:none;border:1px solid var(--border);background:#121317;color:var(--text);border-radius:10px;padding:6px 10px;font-weight:800;cursor:pointer;line-height:1;display:flex;align-items:center;justify-content:center;min-width:36px}
  #agenda .btn[aria-disabled="true"]{opacity:.5;cursor:not-allowed}
  #agenda .btn:focus{outline:2px solid var(--accent);outline-offset:2px}
  #agenda .btn:active{transform:translateY(1px)}
  #agenda .range{font-weight:800;letter-spacing:.3px}

  #agenda .table-wrap{width:100%;max-width:var(--container-w);background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow);overflow-x:auto;border:1px solid var(--border)}
  #agenda table{width:100%;border-collapse:collapse;text-align:center;font-size:13px;table-layout:fixed}
  #agenda th,#agenda td{padding:6px 3px;border-bottom:1px solid var(--border);border-right:1px solid rgba(255,255,255,0.05);white-space:nowrap;text-align:center;vertical-align:middle}
  #agenda tr td:last-child, #agenda tr th:last-child{border-right:none}
  #agenda th{background:rgba(255,214,10,.08);color:var(--accent);font-weight:800;text-transform:uppercase;font-size:11px;position:sticky;top:0;z-index:1;text-align:center}
  #agenda thead th:first-child{width:10%;text-align:center}
  #agenda tbody tr:nth-child(even){background:#1a1c20}
  #agenda tbody td{font-weight:700;text-align:center}
  #agenda tbody td:first-child{color:var(--accent);font-weight:900;text-align:center;font-size:11px}

  #agenda tfoot tr{background:#16181c;text-align:center}
  #agenda tfoot td{border-top:1px solid var(--border);border-bottom:none;color:var(--text);text-align:center}

  /* Numeri con forte ombra per massima leggibilità su giallo pieno */
  #agenda td>.v, #agenda tfoot td>.v{
    display:inline-block;min-width:1.6em;padding:2px 5px;border:1px solid var(--border);border-radius:6px;line-height:1.1;font-weight:800;font-size:12px;text-align:center;color:var(--text);background-color:rgba(255,214,10,0.12);
    text-shadow: 0 0 1px #000, 0 1px 0 #000, 0 0 2px rgba(0,0,0,.95);
  }

  /* SUMMARY stile ChatGPT: più bold + shimmer morbido (fallback per reduced motion) */
  #agenda .summary{max-width:var(--container-w);width:100%;color:var(--muted);font-size:15px;text-align:center;line-height:1.6;margin-top:8px;font-weight:700}
  #agenda .summary .line{opacity:0;transform:translateY(6px);filter:blur(2px);display:inline-block;
    animation:fadeUpAgenda .6s forwards cubic-bezier(.22,.72,.24,1), shimmer 2.6s ease-in-out infinite .4s;
    background:linear-gradient(90deg, rgba(255,255,255,.25) 0%, rgba(255,255,255,.85) 50%, rgba(255,255,255,.25) 100%);
    background-size:200% 100%; -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;}
  @keyframes fadeUpAgenda{to{opacity:1;transform:translateY(0);filter:blur(0)}}
  @keyframes shimmer{0%{background-position:0% 50%}100%{background-position:200% 50%}}
  @media (prefers-reduced-motion: reduce){
    #agenda .summary .line{animation:fadeUpAgenda .6s forwards; background:none; -webkit-text-fill-color:unset; color:var(--muted)}
  }

  /* Disattiva glow dopo il primo avvio */
  .no-glow #agenda .summary .line{animation:fadeUpAgenda .6s forwards; background:none; -webkit-text-fill-color:unset; color:var(--muted)}

  #agenda #delta .line { display:inline-block; width:100%; text-align:center; }

  #avanz .hd { display:flex; flex-direction:column; align-items:center; justify-content:center; }
  #avanz .hd h1.ico { display:flex; align-items:center; justify-content:center; }

  @media(max-width:560px){
    #agenda .a-root{padding:10px}
    #agenda table{font-size:10px}
    #agenda th,#agenda td{padding:3px 2px}
    #agenda thead th:first-child{width:12%}
    #agenda .btn{min-width:32px;padding:6px 8px}
    #agenda .range{font-size:13px}
  }
</style>

<!-- ====== BLOCCO 2: Avicoli prenotati ====== -->
<style>
  [data-ocapi]{
    --bg:#0a0a0b; --panel:#14161a; --panel-2:#1a1d22; --fg:#f3f4f5; --muted:#a7abb1; --hair:#262a30; --accent:#f2cf57;
    --oc:#5a8fe3; --an:#d85b5b; --cap:#dcb24a; --ok:#4eb872; --radius:14px; --shadow:0 12px 36px rgba(0,0,0,.38);
  }
  /* Wrap come in #avanz per adattamento dinamico */
  #prenotati .wrap{width:100%;max-width:var(--container-w);display:grid;gap:14px}

  /* Card esterna IDENTICA alle card di #avanz */
  [data-ocapi] .card-like{
    background:var(--panel); border:1px solid var(--hair); border-radius:var(--radius);
    box-shadow:var(--shadow); padding:16px 14px; width:100%; max-width:100%; margin:0; display:grid; gap:12px; box-sizing:border-box;
  }
  [data-ocapi] .panel{ background:transparent; border:0; border-radius:var(--radius); max-width:100%; width:100%; padding:0; display:grid; gap:16px }

  /* Ribbon come testata/contatore */
  [data-ocapi] .ribbon{ background:var(--panel-2); border:1px solid var(--hair); border-radius:12px; padding:12px 14px; display:flex; justify-content:center; align-items:center; gap:10px; text-align:center; }
  [data-ocapi] .ribbon .label{font-size:14px;font-weight:800;letter-spacing:.3px;color:#c2c5c9;text-transform:uppercase; display:inline-flex; align-items:center; gap:8px}
  [data-ocapi] .ribbon .count{font-size:22px;font-weight:900;color:var(--accent);line-height:1}

  /* Barre categorie (tutte gialle) */
  [data-ocapi] .bars{display:grid;gap:12px; margin-bottom:4px;}
  [data-ocapi] .row{display:grid;grid-template-columns:110px 1fr 76px;align-items:center;gap:10px}
  [data-ocapi] .lbl{font-weight:800;font-size:16px;color:#e6e8ea;text-transform:uppercase;opacity:.95}
  [data-ocapi] .bar{height:18px;border-radius:12px;background:#0f1114;border:1px solid #0b0d11;overflow:hidden}
  [data-ocapi] .bar b{display:block;height:100%;width:0;border-radius:inherit;background:var(--accent)!important}
  /* classi colore legacy lasciate ma sovrascritte dall'!important */
  [data-ocapi] .oche b{background:var(--accent)!important}
  [data-ocapi] .anatre b{background:var(--accent)!important}
  [data-ocapi] .capponi b{background:var(--accent)!important}
  [data-ocapi] .polli b{background:var(--accent)!important}

  [data-ocapi] .val{font-size:20px;font-weight:900;text-align:right;color:#ffffff;font-variant-numeric:tabular-nums}

  @media (max-width:430px){
    #prenotati .wrap{gap:12px}
    [data-ocapi] .card-like{padding:14px}
    [data-ocapi] .row{grid-template-columns:98px 1fr 64px; gap:8px}
    [data-ocapi] .bar{height:16px}
    [data-ocapi] .val{font-size:18px}
    [data-ocapi] .ribbon .count{font-size:20px}
    [data-ocapi] .lbl{font-size:15px}
  }
</style>

<!-- ====== BLOCCO 3: Avanzamento 2025 e Confronti ====== -->
<style>
  #avanz{
    --bg:#0a0a0b; --panel:#14161a; --panel-2:#1a1d22; --hair:#262a30; --fg:#eef0f3; --muted:#a7abb1; --hl:#f2cf57;
    --y2025:var(--hl); --y2024:#9fa4ad; --y2023:#595e66; --radius:14px; --shadow:0 12px 36px rgba(0,0,0,.38);
  }
  #avanz .wrap{width:100%;max-width:var(--container-w);display:grid;gap:14px}
  #avanz .card{background:var(--panel);border:1px solid var(--hair);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px 14px;display:grid;gap:12px}
  #avanz .hd{display:grid;gap:4px;text-align:center}
  #avanz .hd h1{font-size:18px;font-weight:900;letter-spacing:.25px;color:var(--hl);margin:0}
  #avanz .hd p{font-size:12.5px;color:var(--muted);margin:0}

  #avanz .totale{display:grid;gap:10px}
  #avanz .tot-row{display:flex;justify-content:space-between;align-items:baseline}
  #avanz .tot-row .lbl{font-size:13px;color:#cfd3d8;font-weight:800;letter-spacing:.2px;text-transform:uppercase}
  #avanz .tot-row .val{font-size:26px;font-weight:900;color:var(--hl)}
  #avanz .progline{display:flex;align-items:center;gap:8px}
  #avanz .prog{position:relative;height:18px;background:#0f1114;border:1px solid #0b0d11;border-radius:999px;overflow:hidden;flex:1}
  #avanz .prog b{display:block;height:100%;width:0;background:var(--y2025);border-radius:inherit}
  #avanz .cap{font-size:12px;color:#d8dbe0;font-weight:800}

  #avanz .sect-hd{font-size:13px;font-weight:800;letter-spacing:.22px;text-transform:uppercase;color:#cfd3d8;margin-top:2px;text-align:center}
  #avanz .rows{display:grid;gap:12px}
  #avanz .row{display:grid;gap:6px}
  #avanz .row .name{font-size:14px;font-weight:800;letter-spacing:.2px;color:#e9ecef}
  #avanz .bars{display:grid;gap:6px}

  #avanz .barline{display:flex;align-items:center;gap:8px}
  #avanz .bar{height:14px;border-radius:999px;overflow:hidden;position:relative;background:#0f1114;border:1px solid #0b0d11;flex:1}
  #avanz .bar b{display:block;height:100%;width:0}
  #avanz .y2025 b{background:var(--y2025)}
  #avanz .y2024 b{background:var(--y2024)}
  #avanz .y2023 b{background:var(--y2023)}
  #avanz .barline .tag{font-size:13px;font-weight:800;color:#cfd3d8;opacity:.9;min-width:28px;text-align:right}

  #avanz .delta{font-size:12px;font-weight:800;margin-left:6px}
  #avanz .up{color:#5ee07f} #avanz .down{color:#ff8c8c}

  #avanz .legend{display:flex;justify-content:center;align-items:center;gap:14px;margin-top:6px;font-size:13px;color:#cfd3d8;font-weight:800;font-variant-numeric:tabular-nums;text-align:center;width:100%}
  #avanz .legend .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;vertical-align:middle}
  #avanz .legend .dot.y2025{background:var(--y2025)}
  #avanz .legend .dot.y2024{background:var(--y2024)}
  #avanz .legend .dot.y2023{background:var(--y2023)}
  #avanz .note{ text-align:center; font-size:11px; color:#a7abb1; margin-top:4px; }

  @media (max-width:430px){
    #avanz .hd h1{font-size:17px}
    #avanz .tot-row .val{font-size:24px}
    #avanz .prog{height:16px}
    #avanz .row .name{font-size:13.5px}
    #avanz .bar{height:13px}

/* 1) Allarga davvero la gabbia del Blocco 2: niente centratura, ma stretch */
#prenotati.block { align-items: stretch; }            /* override della .block */

/* 2) Assicurati che la gabbia riempia la riga come nel Blocco 3 */
#prenotati .wrap { width: 100%; max-width: var(--container-w); }

/* 3) Evita che contenitori interni reintroducano limiti */
#prenotati [data-ocapi] .card-like,
#prenotati [data-ocapi] .panel,
#prenotati [data-ocapi] .bars { width: 100%; max-width: none; }

/* 4) Barre davvero “fluide”: la colonna centrale prende tutto lo spazio */
#prenotati [data-ocapi] .row {
  grid-template-columns: minmax(98px, 140px) 1fr minmax(64px, 100px);
}
    
  }
</style>

<!-- ====== Icone minimal (gialle) ====== -->
<style>
  .ico{display:inline-flex;align-items:center;gap:8px;color:#f2cf57}
  .ico::before{content:"";display:inline-block;width:1.05em;height:1.05em;background:currentColor;mask-size:contain;mask-repeat:no-repeat;mask-position:center;-webkit-mask-size:contain;-webkit-mask-repeat:no-repeat;-webkit-mask-position:center;margin-right:6px}
  /* Calendar icon */
  .ico-cal::before{mask:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M6 2h2v4H6zM16 2h2v4h-2z'/><rect x='3' y='4' width='18' height='17' rx='3'/><rect x='3' y='8' width='18' height='13'/></svg>");-webkit-mask:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M6 2h2v4H6zM16 2h2v4h-2z'/><rect x='3' y='4' width='18' height='17' rx='3'/><rect x='3' y='8' width='18' height='13'/></svg>")}
  /* Award icon */
  .ico-trophy::before{mask:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M5 4h14v2a4 4 0 0 1-4 4h-1a5 5 0 0 1-4 0H9A4 4 0 0 1 5 6V4z'/><path d='M8 20h8l-2-4h-4l-2 4z'/><rect x='10' y='10' width='4' height='3'/></svg>");-webkit-mask:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M5 4h14v2a4 4 0 0 1-4 4h-1a5 5 0 0 1-4 0H9A4 4 0 0 1 5 6V4z'/><path d='M8 20h8l-2-4h-4l-2 4z'/><rect x='10' y='10' width='4' height='3'/></svg>")}
  /* Dot blink for ribbon */
  .dot-blink{width:9px;height:9px;border-radius:50%;background:#f2cf57;display:inline-block;margin-right:8px;box-shadow:0 0 10px rgba(242,207,87,.9);animation:dotBlink .9s infinite alternate}
  @keyframes dotBlink{from{opacity:.45;transform:scale(.9)}to{opacity:1;transform:scale(1)}}
</style>
</head>
<body>

<!-- ====== BLOCCO 1: AGENDA MACELLAZIONE ====== -->
<section id="agenda" class="block" aria-labelledby="bl1">
  <h1 id="bl1" class="block-title">Blocco 1 • Agenda macellazione</h1>
  <div class="a-root" aria-label="Agenda macellazione">
    <h1 class="ico ico-cal">Agenda Macellazione</h1>
    <div class="week-nav" role="group" aria-label="Seleziona settimana">
      <button id="prev" class="btn" type="button" aria-label="Settimana precedente" aria-disabled="false">◀</button>
      <div class="range" id="range">—</div>
      <button id="next" class="btn" type="button" aria-label="Settimana successiva" aria-disabled="false">▶</button>
    </div>

    <div class="table-wrap">
      <table id="tabella">
        <thead>
          <tr>
            <th></th><th>Oche</th><th>Anatre</th><th>Cap</th><th>Pol</th><th>Tot</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot></tfoot>
      </table>
    </div>

    <p id="summary" class="summary" aria-live="polite"></p>
    <p id="stats" class="summary" aria-live="polite"></p>
    <p id="delta" class="summary" aria-live="polite"></p>
  </div>
</section>

<!-- ====== BLOCCO 2: AVICOLI PRENOTATI ====== -->
<section class="block" id="prenotati" aria-labelledby="bl2">
  <h1 id="bl2" class="block-title">Blocco 2 • Avicoli prenotati</h1>
  <section data-ocapi>
    <div class="wrap">
      <div class="card-like">
        <section class="panel" aria-label="Ancora da macellare e dettaglio categorie">
          <div class="ribbon" aria-live="polite" aria-label="Ancora da macellare totale">
            <span class="label"><i class="dot-blink" aria-hidden="true"></i>Ancora da macellare</span>
            <span class="count">0</span>
          </div>

          <div class="bars" role="list">
            <div class="row oche" role="listitem" data-val="13">
              <div class="lbl">OCHE</div><div class="bar" aria-hidden="true"><b></b></div><div class="val">13</div>
            </div>
            <div class="row anatre" role="listitem" data-val="23">
              <div class="lbl">ANATRE</div><div class="bar" aria-hidden="true"><b></b></div><div class="val">23</div>
            </div>
            <div class="row capponi" role="listitem" data-val="16">
              <div class="lbl">CAPPONI</div><div class="bar" aria-hidden="true"><b></b></div><div class="val">16</div>
            </div>
            <div class="row polli" role="listitem" data-val="33">
              <div class="lbl">POLLI</div><div class="bar" aria-hidden="true"><b></b></div><div class="val">33</div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </section>
</section>

<!-- ====== BLOCCO 3: AVANZAMENTO 2025 E CONFRONTI ====== -->
<section id="avanz" class="block" aria-labelledby="bl3">
  <h1 id="bl3" class="block-title">Blocco 3 • Avanzamento 2025 e confronti</h1>
  <main class="wrap">
    <section class="card" id="card-total">
      <div class="hd">
        <h1 class="ico ico-trophy">TOTALE AVICOLI 2025</h1>
        <p>Tutti gli avicoli ordinati finora</p>
      </div>
      <div class="totale">
        <div class="tot-row"><span class="lbl">Totale 2025</span><span class="val" id="tot2025">0</span></div>
        <div class="progline"><div class="prog"><b id="progFill"></b></div><span class="cap" id="capRecord">204</span></div>
      </div>
      <p class="note">204 avicoli prenotati, record del 2023</p>
    </section>

    <section class="card" id="card-compare">
      <div class="sect-hd">Confronto avicoli negli anni</div>
      <div class="rows" id="rows"></div>
      <div class="legend" aria-hidden="true">
        <span><i class="dot y2025"></i>2025</span>
        <span><i class="dot y2024"></i>2024</span>
        <span><i class="dot y2023"></i>2023</span>
      </div>
      <p class="note">variazione % sull'anno precedente</p>
    </section>
  </main>
</section>

<script type="module">
/* ========================
   CONFIG & UTILITIES
======================== */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS6a2Ij-RW70-i-hk_Qw_0gChVKzsVljdvMjSNwqpF4CXyeHfDurxRBIcGa8AEd0HR-tNW6y_LZSn5t/pub?gid=2121991604&single=true&output=csv";

// Dizionario sinonimi per intestazioni (case/accents insensitive)
const COLMAP = {
  data: ["data","date","giorno","day"],
  oche: ["oche","oca","geese","goose"],
  anatre: ["anatre","anatra","ducks","duck"],
  capponi: ["capponi","cappone","cap","capp"],
  polli: ["polli","pollo","pol","chicken","chickens"]
};

const IT_MONTHS = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];
const IT_DAYS_SHORT = ["L","M","M","G","V","S","D"]; // Lunedì..Domenica
const IT_DAYS_LONG = ["Lunedì","Martedì","Mercoledì","Giovedì","Venerdì","Sabato","Domenica"];

// Normalizza stringhe per match robusto
const norm = s => s?.toString().trim().toLowerCase()
  .normalize("NFD").replace(/\p{Diacritic}/gu,"");

// CSV parser piccolo ma robusto (virgolette/virgole)
function parseCSV(text){
  const rows=[]; let cur="", row=[], inQ=false;
  for (let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if (c === '"'){
      if (inQ && n === '"'){ cur+='"'; i++; }
      else inQ = !inQ;
    } else if (c === ',' && !inQ){ row.push(cur); cur=""; }
    else if ((c === '\n' || c === '\r') && !inQ){
      if (cur.length || row.length){ row.push(cur); rows.push(row); row=[]; cur=""; }
    } else { cur += c; }
  }
  if (cur.length || row.length){ row.push(cur); rows.push(row); }
  return rows;
}

// Trova indice colonna per chiave logica (es. "oche")
function resolveColIdx(headers, key){
  const wanted = COLMAP[key];
  if (!wanted) return -1;
  for (let i=0;i<headers.length;i++){
    const h = norm(headers[i]);
    if (wanted.some(w => norm(w) === h)) return i;
  }
  return -1;
}

// Converte stringa -> numero intero sicuro
const toInt = v => {
  if (v == null) return 0;
  const n = parseInt(String(v).replace(/[^\d\-]/g,""),10);
  return Number.isFinite(n) ? n : 0;
};

// Parse data italiana o ISO (tollerante)
function parseDate(v){
  const s = String(v).trim();
  // Prova ISO diretta
  let d = new Date(s);
  if (!isNaN(d)) return d;
  // Prova formati tipici gg/mm/aaaa o gg-mm-aaaa
  const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
  if (m){
    const [_, dd, mm, yyyy] = m;
    const Y = parseInt(yyyy.length===2 ? "20"+yyyy : yyyy,10);
    const D = new Date(Y, parseInt(mm,10)-1, parseInt(dd,10));
    if (!isNaN(D)) return D;
  }
  return null;
}

// Trova lunedì della settimana della data
function mondayOf(d){
  const dt = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const dow = (dt.getDay()+6)%7; // 0 = Lunedì
  dt.setDate(dt.getDate() - dow);
  dt.setHours(0,0,0,0);
  return dt;
}
function addDays(d,n){
  const x = new Date(d); x.setDate(x.getDate()+n); return x;
}

// Range label tipo "7–13 Ottobre"
function formatWeekLabel(mon){
  const sun = addDays(mon,6);
  const d1 = mon.getDate();
  const d7 = sun.getDate();
  const month = IT_MONTHS[sun.getMonth()];
  return `${d1}\u2013${d7} ${month}`;
}

/* ========================
   LOAD DATA FROM CSV
======================== */
async function loadData(){
  const res = await fetch(CSV_URL, { cache: "no-store" });
  if (!res.ok) throw new Error("CSV non raggiungibile");
  const raw = await res.text();
  const rows = parseCSV(raw);
  if (!rows.length) throw new Error("CSV vuoto");
  const headers = rows[0];
  const body = rows.slice(1);

  const idx = {
    data:   resolveColIdx(headers,"data"),
    oche:   resolveColIdx(headers,"oche"),
    anatre: resolveColIdx(headers,"anatre"),
    cap:    resolveColIdx(headers,"capponi"),
    polli:  resolveColIdx(headers,"polli"),
  };

  // Se mancano colonne essenziali, fallback sicuro
  if (idx.data < 0) throw new Error("Colonna 'data' non trovata nel CSV");
  // Le altre, se assenti, vengono considerate 0.

  // Record normalizzati
  const recs = body.map(r => {
    const d = parseDate(r[idx.data]);
    if (!d) return null;
    return {
      date: d,
      y: d.getFullYear(),
      o: toInt(r[idx.oche]),
      a: toInt(r[idx.anatre]),
      c: toInt(r[idx.cap]),
      p: toInt(r[idx.polli]),
    };
  }).filter(Boolean);

  return recs;
}

/* ========================
   BUILD DATASETS FOR UI
======================== */
function buildWeeks(recs){
  // Gruppo per settimana (Lunedì->Domenica), sommo per giorno
  const byWeek = new Map(); // key = monday ISO string
  for (const r of recs){
    const mon = mondayOf(r.date);
    const key = mon.toISOString().slice(0,10);
    if (!byWeek.has(key)) byWeek.set(key, { mon, days: Array(7).fill(null).map(()=>({o:0,a:0,c:0,p:0})) });
    const pack = byWeek.get(key);
    const dow = (r.date.getDay()+6)%7; // 0..6 (L..D)
    pack.days[dow].o += r.o;
    pack.days[dow].a += r.a;
    pack.days[dow].c += r.c;
    pack.days[dow].p += r.p;
  }

  // Ordino per settimana e trasformo nel formato consumato dall’Agenda
  const weeks = Array.from(byWeek.values()).sort((A,B)=>A.mon-B.mon).map(w=>{
    const label = formatWeekLabel(w.mon);
    const rows = w.days.map((d, i) => {
      const tot = d.o + d.a + d.c + d.p;
      const short = IT_DAYS_SHORT[i] + " " + addDays(w.mon,i).getDate();
      return [short, d.o, d.a, d.c, d.p, tot];
    });
    return { label, rows };
  });

  // Se non ci sono settimane nel CSV, restituisco array vuoto (il renderer userà fallback)
  return weeks;
}

function buildRemaining(recs, today=new Date()){
  // "Ancora da macellare": sommo solo date >= oggi
  const t0 = new Date(today.getFullYear(), today.getMonth(), today.getDate()); // h00
  let O=0,A=0,C=0,P=0;
  for (const r of recs){
    if (r.date >= t0){ O+=r.o; A+=r.a; C+=r.c; P+=r.p; }
  }
  return { o:O, a:A, c:C, p:P, total: O+A+C+P };
}

function buildYearCompare(recs){
  const years = new Map(); // y -> {Oche,Anatre,Capponi,Polli}
  for (const r of recs){
    if (!years.has(r.y)) years.set(r.y, { Oche:0, Anatre:0, Capponi:0, Polli:0, tot:0 });
    const y = years.get(r.y);
    y.Oche   += r.o;
    y.Anatre += r.a;
    y.Capponi+= r.c;
    y.Polli  += r.p;
    y.tot    += r.o + r.a + r.c + r.p;
  }

  // Prendo 2023, 2024, 2025 se esistono (mantenendo l’ordine UI)
  const y2023 = years.get(2023) || { Oche:0, Anatre:0, Capponi:0, Polli:0, tot:0 };
  const y2024 = years.get(2024) || { Oche:0, Anatre:0, Capponi:0, Polli:0, tot:0 };
  const y2025 = years.get(2025) || { Oche:0, Anatre:0, Capponi:0, Polli:0, tot:0 };

  // Record storico (mantengo 204 se vuoi fisso) oppure calcolo max storico
  const record = Math.max(204, y2023.tot, y2024.tot); // così non “rompo” la tua nota UI

  return { y2023, y2024, y2025, record };
}

/* ========================
   RENDERERS (stessa UI)
======================== */
function renderAgenda(weeks){
  // Fallback ai dati demo se weeks è vuoto
  const DEMO = [
    { label: '7–13 Ottobre',  rows: [['L 7',1,0,2,1,4],['M 8',0,1,3,1,5],['M 9',2,0,1,2,5],['G 10',1,1,0,1,3],['V 11',2,2,1,2,7],['S 12',1,3,1,1,6],['D 13',0,1,2,1,4]] },
    { label: '14–20 Ottobre', rows: [['L 14',1,0,3,2,6],['M 15',0,1,4,1,6],['M 16',2,0,1,3,6],['G 17',3,2,0,1,6],['V 18',1,2,3,2,8],['S 19',0,3,1,1,5],['D 20',2,1,2,2,7]] },
    { label: '21–27 Ottobre', rows: [['L 21',0,2,1,1,4],['M 22',1,0,2,2,5],['M 23',2,1,3,1,7],['G 24',1,2,1,1,5],['V 25',0,3,0,2,5],['S 26',1,1,2,0,4],['D 27',2,2,2,1,7]] }
  ];
  const WEEKS = weeks && weeks.length ? weeks : DEMO;

  // Battute venete (mantengo il tuo sistema + fallback locale)
  const JOKES_URL = './veneto-jokes.json';
  const venetoJokesFallback = ["Xe bon, ghe semo!"];
  let venetoJokes = [...venetoJokesFallback];
  fetch(JOKES_URL, { cache:'no-store' }).then(r=>r.ok?r.json():[]).then(arr=>{
    if (Array.isArray(arr) && arr.length) venetoJokes = arr.filter(s=>typeof s==='string' && s.trim());
  }).catch(()=>{});

  const agenda = document.getElementById('agenda');
  const tbody = agenda.querySelector('#tabella tbody');
  const tfoot = agenda.querySelector('#tabella tfoot');
  const rangeEl = agenda.querySelector('#range');
  const summaryEl = agenda.querySelector('#summary');
  const statsEl = agenda.querySelector('#stats');
  const deltaEl = agenda.querySelector('#delta');
  const prevBtn = agenda.querySelector('#prev');
  const nextBtn = agenda.querySelector('#next');

  // glow una sola volta (rispetto tua logica)
  const firstRunKey = "agendaGlowDone";
  if (localStorage.getItem(firstRunKey)) {
    document.body.classList.add("no-glow");
  } else {
    localStorage.setItem(firstRunKey, "1");
  }

  let idx = Math.min(1, WEEKS.length-1); // apri sulla settimana centrale se possibile

  const itNum = (n, dec=1) => Number(n).toFixed(dec).replace('.', ',');
  const getOpacity = (value) => Math.min(value/10, 1).toFixed(2);

  function renderWeek(){
    const w = WEEKS[idx];
    rangeEl.textContent = w.label;

    tbody.innerHTML = '';
    const tot = [0,0,0,0,0];
    for (const r of w.rows){
      const [g,o,a,c,p,t] = r;
      tot[0]+=o; tot[1]+=a; tot[2]+=c; tot[3]+=p; tot[4]+=t;
      tbody.insertAdjacentHTML('beforeend',
        `<tr>
          <td>${g}</td>
          <td><span class="v" style="background-color:rgba(255,214,10,${getOpacity(o)})">${o}</span></td>
          <td><span class="v" style="background-color:rgba(255,214,10,${getOpacity(a)})">${a}</span></td>
          <td><span class="v" style="background-color:rgba(255,214,10,${getOpacity(c)})">${c}</span></td>
          <td><span class="v" style="background-color:rgba(255,214,10,${getOpacity(p)})">${p}</span></td>
          <td><span class="v" style="background-color:rgba(255,214,10,${getOpacity(t)})"><b>${t}</b></span></td>
        </tr>`);
    }

    tfoot.innerHTML =
      `<tr>
        <td><span class='v'>Tot</span></td>
        <td><span class='v' style="background-color:rgba(255,214,10,${getOpacity(tot[0])})">${tot[0]}</span></td>
        <td><span class='v' style="background-color:rgba(255,214,10,${getOpacity(tot[1])})">${tot[1]}</span></td>
        <td><span class='v' style="background-color:rgba(255,214,10,${getOpacity(tot[2])})">${tot[2]}</span></td>
        <td><span class='v' style="background-color:rgba(255,214,10,${getOpacity(tot[3])})">${tot[3]}</span></td>
        <td><span class='v' style="background-color:rgba(255,214,10,${getOpacity(tot[4])})"><b>${tot[4]}</b></span></td>
      </tr>`;

    summaryEl.innerHTML =
      `<span class="line" style="animation-delay:0ms">
        Questa settimana al Tatone servono ${tot[0]} oche, ${tot[1]} anatre, ${tot[2]} capponi, ${tot[3]} polli, per un totale di ${tot[4]} avicoli prenotati.
      </span>`;

    const totalsPerDay = w.rows.map(r=>r[5]);
    const maxVal = Math.max(...totalsPerDay);
    const maxIdxs = totalsPerDay.map((v,i)=>v===maxVal?i:null).filter(i=>i!==null);
    const daysStr = maxIdxs.map(i=>IT_DAYS_LONG[i]).join(', ');
    const busiest = maxIdxs.length>1
      ? `i giorni più carichi sono ${daysStr} con ${maxVal} capi.`
      : `il giorno più carico è ${daysStr} con ${maxVal} capi.`;
    const avg = itNum(tot[4]/7,1);
    const prepHours = Math.round((tot[4]*20)/60);

    statsEl.innerHTML =
      `<span class="line" style="animation-delay:300ms)">
        La media giornaliera è di ${avg} capi, ${busiest} Tempo totale settimanale di preparazione: ${prepHours} ore (calcolo 20 minuti ad avicolo).
      </span>`;

    // Delta vs settimana precedente (se disponibile)
    let perc = 0;
    if (idx > 0) {
      const prevTot = WEEKS[idx-1].rows.reduce((a,r)=>a+r[5],0);
      if (prevTot > 0) perc = Math.round(((tot[4]-prevTot)/prevTot)*100);
    }
    const deltaTxt = `${perc>=0?`+${perc}%`:`${perc}%`} rispetto alla settimana precedente`;

    const joke=(Math.random()<0.33)?` <em style=\"opacity:.85\">${venetoJokes[Math.floor(Math.random()*venetoJokes.length)]}</em>`:'';
    deltaEl.innerHTML = `<span class="line" style="animation-delay:600ms">${deltaTxt}${joke}</span>`;

    const atStart = (idx === 0);
    const atEnd = (idx === WEEKS.length - 1);
    const prevBtnEl = document.getElementById('prev');
    const nextBtnEl = document.getElementById('next');
    prevBtnEl.disabled = atStart; nextBtnEl.disabled = atEnd;
    prevBtnEl.setAttribute('aria-disabled', String(atStart));
    nextBtnEl.setAttribute('aria-disabled', String(atEnd));
  }

  function go(delta){
    const agenda = document.getElementById('agenda');
    const rangeEl = agenda.querySelector('#range');
    const currentLabel = rangeEl.textContent;
    const currentIdx = WEEKS.findIndex(w=>w.label===currentLabel);
    let idx = currentIdx >= 0 ? currentIdx : 0;
    idx = Math.min(Math.max(idx + delta, 0), WEEKS.length - 1);
    // re-render
    // hack: reattach listeners safely
    renderWeek.idx = idx;
    renderWeek();
  }

  // Bind frecce
  document.getElementById('prev').onclick = ()=>go(-1);
  document.getElementById('next').onclick = ()=>go(1);
  window.addEventListener('keydown', e=>{
    if(e.key==='ArrowLeft') go(-1);
    else if(e.key==='ArrowRight') go(1);
  });

  // Prima render
  renderWeek.idx = Math.min(1, WEEKS.length-1);
  renderWeek();
}

function renderPrenotati(rem){
  // Se non ho dati, usa i valori hardcoded nel markup
  const container = document.querySelector('[data-ocapi]');
  if (!container) return;

  const setRow = (cls, value) => {
    const row = container.querySelector(`.${cls}.row`);
    if (!row) return;
    row.dataset.val = String(value);
    const valEl = row.querySelector('.val'); if (valEl) valEl.textContent = String(value);
  };

  if (rem){
    setRow("oche", rem.o);
    setRow("anatre", rem.a);
    setRow("capponi", rem.c);
    setRow("polli", rem.p);
    const totalEl = container.querySelector('.ribbon .count');
    if (totalEl) totalEl.textContent = String(rem.total);
  }

  // Ricalcola larghezze barre (come facevi tu)
  const rows = Array.from(container.querySelectorAll('.bars .row'));
  const values = rows.map(r => parseInt(r.dataset.val, 10) || 0);
  const max = Math.max(...values, 1);
  rows.forEach((r,i) => {
    const v = values[i];
    const b = r.querySelector('.bar b');
    if(b){
      let pct = (v / max) * 100;
      if (v>0) pct = Math.max(pct, 12);
      b.style.width = '0%';
      b.style.transition = 'width .55s cubic-bezier(.22,.72,.24,1)';
      requestAnimationFrame(()=>{ b.style.width = pct + '%'; });
    }
  });
}

function renderAvanzamento(years){
  // RECORD (mantengo la tua nota "204 avicoli prenotati, record del 2023")
  const RECORD = years?.record ?? 204;
  const data = years ? {
    y2023: years.y2023,
    y2024: years.y2024,
    y2025: years.y2025
  } : {
    y2023: { Oche:71, Anatre:26, Capponi:87, Polli:20 },
    y2024: { Oche:73, Anatre:23, Capponi:71, Polli:21 },
    y2025: { Oche:13, Anatre:23, Capponi:16, Polli:33 }
  };

  const tot2025 = (data.y2025.Oche + data.y2025.Anatre + data.y2025.Capponi + data.y2025.Polli);

  const totEl = document.getElementById('tot2025');
  const progFill = document.getElementById('progFill');
  const capRecordEl = document.getElementById('capRecord');
  if (totEl) totEl.textContent = String(tot2025);
  if (capRecordEl) capRecordEl.textContent = String(RECORD);

  const pctTot = Math.max(0, Math.min(100, (tot2025 / RECORD) * 100));
  if (progFill){
    progFill.style.width = '0%';
    void progFill.offsetWidth;
    progFill.style.transition = 'width .6s cubic-bezier(.22,.72,.24,1)';
    progFill.style.width = pctTot + '%';
  }

  const rowsWrap = document.getElementById('rows');
  if (!rowsWrap) return;
  rowsWrap.innerHTML = '';

  const cats = ["Oche","Anatre","Capponi","Polli"];
  const maxByCat = {};
  for (const cat of cats){
    maxByCat[cat] = Math.max(data.y2023[cat]||0, data.y2024[cat]||0, data.y2025[cat]||0, 1);
  }

  for (const cat of cats){
    const wrap = document.createElement('div');
    wrap.className = 'row';
    const title = document.createElement('div');
    title.className = 'name';
    title.textContent = cat.toUpperCase();
    wrap.appendChild(title);

    const bars = document.createElement('div');
    bars.className = 'bars';
    wrap.appendChild(bars);

    const yearsArr = [
      { color:'y2025', val:data.y2025[cat]||0 },
      { color:'y2024', val:data.y2024[cat]||0 },
      { color:'y2023', val:data.y2023[cat]||0 }
    ];

    for (const y of yearsArr){
      const line = document.createElement('div');
      line.className = 'barline';
      const bar = document.createElement('div');
      bar.className = 'bar ' + y.color;
      const fill = document.createElement('b');
      fill.style.width = '0%';
      fill.style.transition = 'width .6s cubic-bezier(.22,.72,.24,1)';
      bar.appendChild(fill);

      const tag = document.createElement('span');
      tag.className = 'tag';
      tag.textContent = y.val;

      line.appendChild(bar);
      line.appendChild(tag);
      bars.appendChild(line);

      let pct = Math.max(0, Math.min(100, (y.val / maxByCat[cat]) * 100));
      if (y.val > 0) pct = Math.max(pct, 7);
      requestAnimationFrame(()=>{ fill.style.width = pct + '%'; });
    }

    const v25 = data.y2025[cat]||0, v24 = data.y2024[cat]||0;
    const delta = v24===0 ? 0 : Math.round(((v25 - v24) / v24) * 100);
    const d = document.createElement('span');
    d.className = 'delta ' + (delta>=0 ? 'up':'down');
    d.textContent = (delta>=0?'+':'') + delta + '%';
    title.appendChild(d);

    rowsWrap.appendChild(wrap);
  }
}

/* ========================
   BOOTSTRAP
======================== */
(async function main(){
  try{
    const recs = await loadData();

    // 1) Agenda (settimane dalla tabella)
    const weeks = buildWeeks(recs);
    renderAgenda(weeks);

    // 2) Prenotati (ancora da macellare = date future)
    const remaining = buildRemaining(recs, new Date());
    renderPrenotati(remaining);

    // 3) Avanzamento annuale e confronto
    const years = buildYearCompare(recs);
    renderAvanzamento(years);

  } catch (err){
    console.warn("Dati CSV non disponibili o incompleti, uso i demo:", err);
    // Fallback: render con i tuoi dati demo
    renderAgenda([]);          // userà DEMO interno
    renderPrenotati(null);     // lascia i numeri presenti in HTML
    renderAvanzamento(null);   // usa set demo 2023/24/25
  }
})();
</script>

<footer style="text-align:center;padding:24px 0;font-size:12px;color:#a7abb1;letter-spacing:.3px;border-top:1px solid #232429;margin-top:40px;">
  <em>© Ocapì – La Bottega di Casterno 2025 – tutti i diritti riservati</em>
</footer>

</body>
</html>


